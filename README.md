# Домашнее задание к занятию «Резервное копирование баз данных» - Хрипун Алексей

---

## Задание 1 Резервное копирование
### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

Необходимо описать, какие варианты резервного копирования подходят в случаях:

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Решение 1
1.1 Можно настроить репликацию и с реплики выполнять полный бэкап каждую ночь(если база данных не большая). Если база большая, можно делать один раз в неделю полный бэкап и каждую ночь диференциальный или инкрементальный.

1.2 Можно настроить репликацию и выполнить полный бэкап раз в неделю или каждую ночь (в зависимости от размера базы данных) и каждый час с реплики выполнять инкрементальный бэкап. Также нужно убелиться, что на source-сервере ведется бинарный лог-файл базы и он находится не на том же диске, где находится база данных. 

1.3 При некоторых поломках базы данных (аварийное отключение севрера, неисправность диска или дискового контроллера, неполадки с сетью ...) моментальное переключение на работающую базу может обеспечить репликация. Если же поломка произошла в самой базе (например, администратор удалил таблицу или какие-то нужные строки), то эти изменения придут на сервер-реплику и здесь поможет только бэкап. А восстановление из бэкапа занимает какое-то время.  


## Задание 2 PostgreSQL
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Решение 2
2.1 Базу данных будем бэкапить в динарном формате, чтобы использовать многопоточное восстановление и сжатие:
```
pg_dump -Fc  base_test  -f  base_test.dump

```
Восстановление базы:
```
pg_restore --create -j 5 -d base_test.dump 

```
2.2 Скрипт для резервного копирования базы PostgreSQL:
```
db_name=base_test
db_user=dbuser
backupfolder=~/postgresql/backups 
sqlfile=$backupfolder/database-$(date +%d-%m-%Y_%H-%M-%S).sql

if pg_dump -U $db_user $db_name > $sqlfile ; then
   echo 'Sql dump created'
else
   echo 'pg_dump return non-zero code' 
   exit
fi
```

## Задание 3. MySQL
3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL.

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение 3.
3.1 Для инкрементного резервного копирования нужно использовать бинарные лог-файлы. При создания полного бэкапа очищается бинарный лог-файл, и созданный впоследствии лог-файл будет содержать изменения после создания бэкапа:
```
mysqldump --single-transaction --flush-logs --source-data=2 --all-databases > backup_bases.sql

```
3.1* Реплика дает преимущество по сравнению с обычным резервным копированием в том, что позволяет быстро переключить рабочую нагрузку на реплику в случае неожиданного выхода из строя master-ноды. Самые свежие данные будут доступны. Также репликаци позволяет снять нагрузку чтения с master-ноды и переложить ее на серверы-реплики (которых может быть много).  

